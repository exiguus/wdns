name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    lint-test:
        name: Lint & Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version: 1.25.7

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ${{ github.workspace }}/vendor
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install golangci-lint
              uses: golangci/golangci-lint-action@v9
              with:
                  version: v2.8.0

            - name: Run golangci-lint
              run: golangci-lint run ./...

            - name: Install kdig
              run: |
                  sudo apt-get update
                  sudo apt-get install -y knot-dnsutils
                  kdig --version || true

            - name: Run tests
              run: go test ./... -v

    build-and-scan:
        name: Build image and scan
        runs-on: ubuntu-latest
        needs: [lint-test]
        steps:
            - uses: actions/checkout@v6

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile
                  push: false
                  tags: wdns:ci
                  load: true

            - name: Run quick e2e check
              run: |
                  set -euo pipefail
                  echo "Starting container..."
                  CONTAINER=$(docker run -d --rm -p 8080:8080 wdns:ci)
                  echo "container=$CONTAINER"
                  # wait for server startup log
                  for i in $(seq 1 30); do
                    if docker logs "$CONTAINER" 2>&1 | grep -q "Server started on"; then
                      echo "server started"
                      break
                    fi
                    sleep 1
                  done

                  # UDP/default check
                  echo "performing UDP/default test query"
                  RESPONSE=$(curl -s -X POST http://localhost:8080/query \
                    -H 'Content-Type: application/json' \
                    -d '{"nameserver":"1.1.1.1","name":"example.com","type":"A"}')
                  echo "response: $RESPONSE"
                  echo "$RESPONSE" | grep -E -q '"success":[[:space:]]*true' || (echo "e2e failed (udp)"; docker logs "$CONTAINER"; docker stop "$CONTAINER"; exit 1)

                  # TLS (DoT) check
                  echo "performing TLS (DoT) test query"
                  RESPONSE_TLS=$(curl -s -X POST http://localhost:8080/query \
                    -H 'Content-Type: application/json' \
                    -d '{"nameserver":"1.1.1.1","name":"example.com","type":"A","transport":"tls"}')
                  echo "response tls: $RESPONSE_TLS"
                  echo "$RESPONSE_TLS" | grep -E -q '"success":[[:space:]]*true' || (echo "e2e failed (tls)"; docker logs "$CONTAINER"; docker stop "$CONTAINER"; exit 1)

                  # HTTPS (DoH) check
                  echo "performing HTTPS (DoH) test query"
                  RESPONSE_HTTPS=$(curl -s -X POST http://localhost:8080/query \
                    -H 'Content-Type: application/json' \
                    -d '{"nameserver":"1.1.1.1","name":"example.com","type":"A","transport":"https"}')
                  echo "response https: $RESPONSE_HTTPS"
                  echo "$RESPONSE_HTTPS" | grep -E -q '"success":[[:space:]]*true' || (echo "e2e failed (https)"; docker logs "$CONTAINER"; docker stop "$CONTAINER"; exit 1)

                  docker stop "$CONTAINER"

            - name: Run Trivy vulnerability scan (via Docker)
              run: |
                  docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasecurity/trivy:0.44.0 image --format table wdns:ci || true
